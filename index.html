<link rel="stylesheet" href="./style.css">

<style>
  #ui {
    position: absolute;
  }
  #health {
    background-color: red;
  }
</style>

<body>
  <div id="ui">
    <label for="health">Health: </label>
    <progress id="health" value="100" max="100"></progress>
    <div>Wave: <span id="wave"></span></div>
    <div>Enemies: <span id="enemies"></span></div>
  </div>
</body>

<script type="module">

  import { Game } from './src/game.js';
  import { Ship, Rock } from './src/entity.js';
  import { World } from './src/world.js';
  import { Info } from './info/info.js';

  
  const world = new World( 2000, 2000 );
  const background = createBackground( world.width, world.height );

  for ( let i = 0; i < 15; i ++ ) {
    world.spawnInside( new Rock( Info.Rock ) );
  }

  for ( let i = 0; i < 5; i ++ ) {
    world.spawnInside( new Ship( Info.Scout ) );
  }

  const PLAYER_RESPAWN_DELAY = 2000;
  let playerSpawnTimer = PLAYER_RESPAWN_DELAY;
  let player = new Ship( Info.Player );
  world.spawnInside( player );

  let timeSinceLastWave = 0, wave = 1;

  let scrollX = 0, scrollY = 0;

  const healthUI = document.getElementById( 'health' );
  const waveUI = document.getElementById( 'wave' );
  const enemiesUI = document.getElementById( 'enemies' );

  const game = new Game();
  game.update = ( dt ) => {

    if ( player.isAlive() ) {  
      scrollX = Math.min( 0, Math.max( window.innerWidth - world.width, window.innerWidth / 2 - player.x ) );
      scrollY = Math.min( 0, Math.max( window.innerHeight - world.height, window.innerHeight / 2 - player.y ) );
      
      player.goalAngle = Math.atan2( 
        game.mouseY - scrollY - player.y, 
        game.mouseX - scrollX - player.x
      );
      player.isShooting = game.mouseDown;

      player.isSliding = game.keysPressed.has( 'Shift' );
    }
    else {
      playerSpawnTimer -= dt;

      if ( playerSpawnTimer < 0 && game.mouseDown ) {
        playerSpawnTimer = PLAYER_RESPAWN_DELAY;

        player = new Ship( Info.Player );
        world.spawnInside( player );
      }
    }

    timeSinceLastWave += dt;
    
    const enemies = world.entities.filter( e => e != player && e instanceof Ship );
    
    healthUI.value = player.life;
    waveUI.innerText = `${ wave } (${ Math.floor( timeSinceLastWave / 1000 ) })`;
    enemiesUI.innerText = enemies.length;

    if ( timeSinceLastWave > enemies.length * 5000 ) {
      timeSinceLastWave = 0;
      wave ++;

      for ( let i = 0; i < 5; i ++ ) {
        world.spawnOutside( new Ship( Info.Scout ) );
      }
      
      world.spawnOutside( new Ship( Info.Frigate ) );
    }

    enemies.forEach( enemy => enemy.think( player.isAlive() ? player : null, world ) );

    world.update( dt );
  };

  game.draw = ( ctx ) => {
    ctx.save();

    // TODO: Move scroll to game object?
    ctx.translate( scrollX, scrollY );

    ctx.drawImage( background, 0, 0 );
    world.draw( ctx );

    ctx.restore();
  };

  function createBackground( width, height, density = 2000 ) {
    const background = document.createElement( 'canvas' );
    background.width = world.width;
    background.height = world.height;

    const ctx = background.getContext( '2d' );
    
    const numStars = width * height / density;
    for ( let i = 0; i < numStars; i ++ ) {
      const x = Math.random() * width;
      const y = Math.random() * height;
      const r = Math.random() * 1;
      
      ctx.beginPath();
      ctx.arc( x, y, r, 0, Math.PI * 2 );

      const col = Math.random() * 200;
      ctx.fillStyle = `rgb( ${ col }, ${ col }, ${ col } )`;
      ctx.fill();
    }

    return background;
  }

</script>

