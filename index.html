<link rel="stylesheet" href="../style.css">

<body>
</body>

<script type="module">

  import { Game } from '../src/game.js';
  import { Ship, Rock } from '../src/entity.js';
  import { World } from '../src/world.js';
  import { Info } from '../info/info.js';

  
  const world = new World( 2000, 2000 );

  for ( let i = 0; i < 15; i ++ ) {
    world.spawn( new Rock( Info.Rock ) );
  }

  for ( let i = 0; i < 10; i ++ ) {
    world.spawn( new Ship( Info.Enemy ) );
  }

  const PLAYER_RESPAWN_DELAY = 2000;
  let playerSpawnTimer = PLAYER_RESPAWN_DELAY;
  let player = new Ship( Info.Player );
  world.spawn( player );

  let scrollX = 0, scrollY = 0;

  const game = new Game();
  game.update = ( dt ) => {

    if ( player.isAlive() ) {  
      scrollX = window.innerWidth / 2 - player.x;
      scrollY = window.innerHeight / 2 - player.y;
      
      player.goalAngle = Math.atan2( 
        game.mouseY - scrollY - player.y, 
        game.mouseX - scrollX - player.x
      );
      player.isShooting = game.mouseDown;  
    }
    else {
      playerSpawnTimer -= dt;

      if ( playerSpawnTimer < 0 && game.mouseDown ) {
        playerSpawnTimer = PLAYER_RESPAWN_DELAY;

        player = new Ship( Info.Player );
        world.spawn( player );
      }
    }
    
    const enemies = world.entities.filter( e => e != player && e instanceof Ship );
    enemies.forEach( enemy => enemy.think( player.isAlive() ? player : null, world ) );

    world.update( dt );
  };

  game.draw = ( ctx ) => {
    ctx.save();

    ctx.translate( scrollX, scrollY );

    world.draw( ctx );

    ctx.restore();
  };

</script>

