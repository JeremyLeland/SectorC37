<link rel="stylesheet" href="./style.css">

<style>
  #ui {
    position: absolute;
  }
  #health {
    background-color: red;
  }
</style>

<body>
  <div id="ui">
    <label for="health">Health: </label>
    <progress id="health" value="100" max="100"></progress>
    <div>Wave: <span id="wave"></span></div>
    <div>Enemies: <span id="enemies"></span></div>
    <canvas id="minimap" width="100" height="100"></canvas>
  </div>
</body>

<script type="module">

  import { Game } from './src/game.js';
  import { Ship } from './src/Ship.js';
  import { Rock } from './src/Rock.js';
  import { World } from './src/world.js';
  import { Info } from './info/info.js';


  const level = {
    size: 2000,
    entryAngle: 0,
    exitAngle: 3,
    waves: [
      {
        time: 0,
        spawns: [
          { type: "Scout", x: 0, y: 0 },
          { type: "Scout", x: 50, y: -100 },
          { type: "Scout", x: 50, y:  100 },
        ]
      },
      {
        time: 5000,
        spawns: [
          { type: "Scout", x: 0, y: 0 },
          { type: "Scout", x: 50, y: 0 },
          { type: "Frigate", x: 100, y: 0 },
          { type: "Scout", x: 100, y: -100 },
          { type: "Scout", x: 100, y: 100 },
        ]
      },
      {
        time: 10000,
        spawns: [
          { type: "Scout", x: 0, y: 0 },
          { type: "Scout", x: 50, y: -50 },
          { type: "Scout", x: 50, y: 50 },
          { type: "Scout", x: 100, y: -100 },
          { type: "Scout", x: 100, y: 100 },
          { type: "Scout", x: 150, y: 0 },
          { type: "Destroyer", x: 200, y: 0 },
        ]
      },
    ]
  };

  
  const world = new World( level );
  const background = createBackground( world.size * 2, world.size * 2 );

  for ( let i = 0; i < 15; i ++ ) {
    world.spawnInside( new Rock( Info.Rock ) );
  }

  // setInterval( () => world.spawnOutside( new Rock( Info.Rock ) ), 20000 );

  // for ( let i = 0; i < 5; i ++ ) {
  //   world.spawnInside( new Ship( Info.Scout ) );
  // }

  const PLAYER_RESPAWN_DELAY = 2000;
  let playerSpawnTimer = PLAYER_RESPAWN_DELAY;
  let player = new Ship( Info.Player );
  world.spawnInside( player );

  // let timeSinceLastWave = 0, wave = 1;

  const healthUI = document.getElementById( 'health' );
  healthUI.setAttribute( 'max', Info.Player.life );
  const waveUI = document.getElementById( 'wave' );
  const enemiesUI = document.getElementById( 'enemies' );
  const minimapCTX = document.getElementById( 'minimap' ).getContext( '2d' );

  const game = new Game();
  game.update = ( dt ) => {

    if ( player.isAlive() ) {  
      game.scrollX = Math.min( world.size, Math.max( window.innerWidth - world.size, window.innerWidth / 2 - player.x ) );
      game.scrollY = Math.min( world.size, Math.max( window.innerHeight - world.size, window.innerHeight / 2 - player.y ) );
      
      player.goalAngle = Math.atan2( 
        game.mouseY - game.scrollY - player.y, 
        game.mouseX - game.scrollX - player.x
      );
      
      player.isSliding = game.keysPressed.has( 'Control' );
      player.isSprinting = game.keysPressed.has( 'Shift' );

      player.isShooting = game.mouseDown && !player.isSprinting;
    }
    else {
      playerSpawnTimer -= dt;

      if ( playerSpawnTimer < 0 && game.mouseDown ) {
        playerSpawnTimer = PLAYER_RESPAWN_DELAY;

        player = new Ship( Info.Player );
        world.spawnInside( player );
      }
    }

    // timeSinceLastWave += dt;
    
    const enemies = world.entities.filter( e => e != player && e instanceof Ship );
    
    healthUI.value = player.life;
    // waveUI.innerText = `${ wave } (${ Math.floor( timeSinceLastWave / 1000 ) })`;
    enemiesUI.innerText = enemies.length;

    // if ( timeSinceLastWave > 5000 /*enemies.length * 5000*/ ) {
    //   timeSinceLastWave = 0;
    //   wave ++;

    //   for ( let i = 0; i < 5; i ++ ) {
    //     world.spawnOutside( new Ship( Info.Scout ), 0 );
    //   }
      
    //   world.spawnOutside( new Ship( Info.Frigate ), 0 );
    //   world.spawnOutside( new Ship( Info.Destroyer ), 0 );
    // }

    //enemies.forEach( enemy => enemy.think( player.isAlive() ? player : null, world ) );

    world.update( dt );
  };

  game.draw = ( ctx ) => {
    ctx.drawImage( background, -world.size, -world.size );
    world.draw( ctx );
    world.drawMinimap( minimapCTX );
  };

  function createBackground( width, height, density = 2000 ) {
    const background = document.createElement( 'canvas' );
    background.width = world.size * 2;
    background.height = world.size * 2;

    const ctx = background.getContext( '2d' );
    
    const numStars = width * height / density;
    for ( let i = 0; i < numStars; i ++ ) {
      const x = Math.random() * width;
      const y = Math.random() * height;
      const r = Math.random() * 1;
      
      ctx.beginPath();
      ctx.arc( x, y, r, 0, Math.PI * 2 );

      const col = Math.random() * 200;
      ctx.fillStyle = `rgb( ${ col }, ${ col }, ${ col } )`;
      ctx.fill();
    }

    return background;
  }

</script>

