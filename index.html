<link rel="stylesheet" href="../style.css">

<style>
  body {
    background-color: #111;
    /* filter: drop-shadow( -1px 0px ) drop-shadow( 0px 1px ) drop-shadow( 0px -1px ) drop-shadow( 1px 0px); */
  }

  .shape {
    position: absolute;
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 1;
  }

  .player {
    border-color: green;
    clip-path: polygon(0% 0%, 100% 50%, 0% 100%);
  }

  .enemy {
    border-color: blue;
    clip-path: polygon(0% 0%, 100% 50%, 0% 100%);
  }

  .rock {
    border-color: brown;
    clip-path: polygon(50% 0%, 90% 20%, 100% 60%, 75% 100%, 25% 100%, 0% 60%, 10% 20%);
  }

  .flame {
    filter: blur( 1px );
    mix-blend-mode: screen;
  }
  
</style>

<body>

</body>

<script type="module">

  import { Ship, Rock } from '../src/entity.js';
  import { World } from '../src/world.js';
  import { Info } from '../info/info.js';

  const canvas = document.createElement( 'canvas' );
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  document.body.appendChild( canvas );

  const ctx = canvas.getContext( '2d' );

  
  const world = new World();

  for ( let i = 0; i < 15; i ++ ) {
    world.spawn( new Rock( Info.Rock ) );
  }

  for ( let i = 0; i < 15; i ++ ) {
    world.spawn( new Ship( Info.Enemy ) );
  }

  let player = new Ship( Info.Player );
  world.spawn( player );

  let scrollX = 0, scrollY = 0;

  function update( dt ) {

    scrollX = ctx.canvas.width / 2 - player.x;
    scrollY = ctx.canvas.height / 2 - player.y;

    player.goalAngle = Math.atan2( 
      mouseY - scrollY - player.y, 
      mouseX - scrollX - player.x
    );
    
    const enemies = world.entities.filter( e => e != player && e instanceof Ship );
    enemies.forEach( enemy => enemy.think( player, world.entities ) );

    world.update( dt );
  }

  function draw( ctx ) {
    ctx.clearRect( 0, 0, ctx.canvas.width, ctx.canvas.height );

    ctx.save();

    ctx.translate( scrollX, scrollY );

    world.draw( ctx );

    ctx.restore();
  }


  let mouseX = 0, mouseY = 0, mouseDown = false;
  document.onmousemove = onInput;
  document.ontouchmove = onInput;
  document.onmousedown  = ( e ) => { mouseDown = true; onInput( e ); }
  document.ontouchstart = ( e ) => { mouseDown = true; onInput( e ); }
  document.onmouseup  = ( e ) => mouseDown = false;
  document.ontouchend = ( e ) => mouseDown = false;
  function onInput( e ) {
    const event = e.touches ? e.touches[ 0 ] : e;
    mouseX = event.clientX;
    mouseY = event.clientY;
  }

  let lastTime = null;
  function animate( now ) {
    lastTime ??= now;   // for first call only
    update( now - lastTime );
    lastTime = now;

    draw( ctx );

    requestAnimationFrame( animate );
  }
  requestAnimationFrame( animate );

</script>

